<script type="text/javascript">

$(document).ready(function() {

    var checkedCalcsAndProps = {{checkedCalcsAndProps}};
    var url = "";

    addChemaxonData_preAsync({{chemaxonData}});

    // ##### The old loop only for test et. al., chemaxon still synchronous ########
    for (var calc in checkedCalcsAndProps) {
        if (checkedCalcsAndProps.hasOwnProperty(calc) && calc != "chemaxon") {

            for (var i = 0; i < checkedCalcsAndProps[calc].length; i++) {

                //could also be methods in here=
                var prop = checkedCalcsAndProps[calc][i];
                var calcPropData = {"calc": calc, "prop": prop};

                //add loader.gif to cell:
                var tblCell = $('.' + calc + '.' + prop);
                $(tblCell).html('<img src="/static/images/loader.gif" height="20" width="20" />');

                makeTheCall('/test-cts/data/', calcPropData);
                // makeTheCall(calcPropData, responseHandler);
            }
        }
    }
    // ################################################################################


    // !!!!!!!!! Use this for making test et. al. AND chemaxon calls via ajax !!!!!!!!!!!!!!!!!!!!!!!
    // for (var calc in checkedCalcsAndProps) {
    //     if (checkedCalcsAndProps.hasOwnProperty(calc)) {

    //         if (calc == "chemaxon") { 
    //             url = "/jchem-cts/ws/traffic-cop/"
    //         }
    //         else {
    //             url = "/test-cts/data/"
    //         }

    //         for (var i = 0; i < checkedCalcsAndProps[calc].length; i++) {

    //             var prop = checkedCalcsAndProps[calc][i];
    //             var calcPropData = {"calc": calc, "prop": prop};

    //             var tblCell = $('.' + calc + '.' + prop);
    //             $(tblCell).html('<img src="/static/images/loader.gif" height="20" width="20" />');

    //             makeTheCall(url, calcPropData);
    //             // makeTheCall(calcPropData, responseHandler);
    //         }
    //     }
    // }
    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
});


function makeTheCall(url, calcPropData) {
    $.ajax({ 
        url: url,
        type: "POST",
        dataType: "json",
        data: calcPropData,
        // tryCount: 0,
        // retryLimit: 3,
        success: function(data) {
            responseHandler(data);
        },
        error: function(jqXHR, textStatus, errorThrown) {
            // alert("An Error occured. Check console for more information.");
            console.log(errorThrown);
        }
    });
}


function responseHandler(response) {
    //map response to pchemprop output table:
                
    //check data for -9999.0 values, retry if so
    //only retry so many times

    if (response.hasOwnProperty('error')) {
        $('.' + response['calc'] + '.' + response['prop']).html(response['error']);
        return;
    }

    // TODO: Finish retries feature once server 6 is back up and runing
    // if (response['data'] == -9999) {
    //     var calcPropData = {"calc": response['calc'], "prop": response['prop']}
    //     makeTheCall()
    // }

    $('.' + response['calc'] + '.' + response['prop']).html(response['data']);
}


function addChemaxonData_preAsync(chemaxonDict) {
    // after templating the pchemprop output table to reuse
    // the pchemprop input table code, the chemaxon data has
    // to be added to the table dynamically

    console.log("inside chemaxon function");
    console.log(chemaxonDict);

    for (var prop in chemaxonDict) {
        if (chemaxonDict.hasOwnProperty(prop)) {
            console.log(prop);
            var data = JSON.stringify(chemaxonDict[prop]);
            console.log(data);
            $('.chemaxon.' + prop).html(data);
        }
    }


    //  for (var calc in checkedCalcsAndProps) {
    //     if (checkedCalcsAndProps.hasOwnProperty(calc) && calc != "chemaxon") {

    //         for (var i = 0; i < checkedCalcsAndProps[calc].length; i++) {

    //             //could also be methods in here=
    //             var prop = checkedCalcsAndProps[calc][i];
    //             var calcPropData = {"calc": calc, "prop": prop};

    //             //add loader.gif to cell:
    //             var tblCell = $('.' + calc + '.' + prop);
    //             $(tblCell).html('<img src="/static/images/loader.gif" height="20" width="20" />');

    //             makeTheCall(calcPropData);
    //             // makeTheCall(calcPropData, responseHandler);
    //         }
    //     }
    // }
}

</script>